<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Real Time LiDAR Data Visualization With Holoviews and Panel | dwblab - Home of Douglas Breault: Innovative Leadership and Engineering</title>
<meta name=keywords content="sensors"><meta name=description content="This post explores creating a Python dashboard for real-time LiDAR data visualization using Holoviews and Panel. I have used both Streamlit and Plotly for many robotics projects, but the Holoviz ecosystem has intrigued me for many reasons."><meta name=author content><link rel=canonical href=https://dwblab.com/posts/real-time-lidar-data-visualization-holoviews-panel><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://www.dwblab.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://www.dwblab.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://www.dwblab.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://www.dwblab.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://www.dwblab.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Real Time LiDAR Data Visualization With Holoviews and Panel"><meta property="og:description" content="This post explores creating a Python dashboard for real-time LiDAR data visualization using Holoviews and Panel. I have used both Streamlit and Plotly for many robotics projects, but the Holoviz ecosystem has intrigued me for many reasons."><meta property="og:type" content="article"><meta property="og:url" content="https://www.dwblab.com/posts/real-time-lidar-data-visualization-holoviews-panel/"><meta property="og:image" content="https://www.dwblab.com/douglas-breault-headshot.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-09T17:25:51-04:00"><meta property="article:modified_time" content="2023-08-09T17:25:51-04:00"><meta property="og:site_name" content="DWBlab - Douglas Breault: Innovative Leadership and Engineering"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.dwblab.com/douglas-breault-headshot.jpg"><meta name=twitter:title content="Real Time LiDAR Data Visualization With Holoviews and Panel"><meta name=twitter:description content="This post explores creating a Python dashboard for real-time LiDAR data visualization using Holoviews and Panel. I have used both Streamlit and Plotly for many robotics projects, but the Holoviz ecosystem has intrigued me for many reasons."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writings","item":"https://www.dwblab.com/posts/"},{"@type":"ListItem","position":2,"name":"Real Time LiDAR Data Visualization With Holoviews and Panel","item":"https://www.dwblab.com/posts/real-time-lidar-data-visualization-holoviews-panel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Real Time LiDAR Data Visualization With Holoviews and Panel","name":"Real Time LiDAR Data Visualization With Holoviews and Panel","description":"This post explores creating a Python dashboard for real-time LiDAR data visualization using Holoviews and Panel. I have used both Streamlit and Plotly for many robotics projects, but the Holoviz ecosystem has intrigued me for many reasons.","keywords":["sensors"],"articleBody":"Over my two decades of experience in robotics and engineering, I’ve found LiDARs to be integral part of how I’ve used robotic systems. I’ve used LiDARs for applications ranging from localization and mapping to obstacle avoidance, safety systems, and ground truth tracking. Most of the LiDARs I’ve used have been industrial grade devices, and today I have a hobbyist grade LiDAR that I need to get running before I put it on a home project. This presents me with an opportunity to finally explore Holoviews and Panel using some high-frequency real-time sensor data.\nIn exploring new technologies and tools within the data visualization and dashboard creation space, my curiosity is continually drawn to Holoviews and Panel. Holoviews is a Python library designed to simplify data visualization and is capable of using different backends, including Matplotlib and Bokeh. Panel is, like Holoviews, part of the Holoviz system and is a high-level dashboarding solution, allowing users to create interactive, web-based applications.\nWhat sets Holoviews and Panel apart from commercial options like Plotly and Streamlit is their robust, community-driven open-source ethos. For personal projects, I will always give preference to community driven Free/Libre Open Source Software.\nThe technical underpinnings of Panel also offer a compelling case for its adoption over alternatives. My experience with Streamlit, while incredibly positive, has been tempered by its stateless model. Streamlit’s approach, where the app’s state is not preserved between user interactions, causing the entire script to rerun with every action, can be less than ideal. This model often results in performance bottlenecks, particularly in data-intensive applications common in my work. Panel, on the other hand, utilizes a stateful model, allowing for partial updates and, crucially, more efficient handling of live data streams.\nTesting this LiDAR gave me a perfect excuse to explore the capabilities of Holoviews and Panel. I am particularly interested in how the plotting interfaces feel, how much boilerplate Panel needs to get something running, and how performant the visualizations and dashboards can be with a real-time data stream.\nSetting Up the LiDAR System The LiDAR is a Slamtec RPLiDAR A2M8. It is a 2D 360° scanner with an 8-meter range. It can scan at 5-15 Hz and has an angular resolution of 0.9° at 10 Hz. When working with any sensor, the first thing you should do is pull up the data sheets and manuals! In this case, it is a straight-forward and easy to use sensor that has a number of options for using it. There’s a ROS (Robotic Operating System) driver, which appears to be the most popular way to interface, but that’s not appropriate for my project. I don’t need to use a library, but PyRPlidar appears to be a solid implementation of the protocol and will save us time getting started.\nThe first step is to plug the scanner into the computer and see if it shows up. Using a Linux computer, which all instructions will assume, the most basic way to check is to run $ sudo dmesg to get some information about the device and see where it has attached.\n$ sudo dmesg [...] [86398.0045891] usb 5-4: New USB device found, idVendor=10c4, idProduct=ea60, bcdDevice= 1.00 [86398.045898] usb 5-4: New USB device strings: Mfr=1, Product=2, SerialNumber=3 [86398.045901] usb 5-4: Product: CP2102 USB to UART Bridge Controller [86398.045905] usb 5-4: Manufacturer: Silicon Labs [86398.045908] usb 5-4: SerialNumber: 0001 [86398.075170] usbcore: registered new interface driver usbserial_generic [86398.075183] usbserial: USB Serial support registered for generic [86398.076474] usbcore: registered new interface driver cp210x [86398.076486] usbserial: USB Serial support registered for cp210x [86398.076525] cp210x 5-4:1.0: cp210x converter detected [86398.080941] usb 5-4: cp210x converter now attached to ttyUSB0 Since I am accessing the device on a tty* I need to be in the dialout group. I run $ groups and see that my user is not in this group. I add it with:\n$ sudo usermod -aG dialout $USER It is important to note that this change does not take effect immediately. Shells, and even your GUI login, need to be restarted for changes to your user’s groups to take effect. You can forge ahead in your open shell on most systems by calling $ newgrp. This step often trips up many people, especially those not fluent in Linux. This is not hard stuff but can be quite tricky if you’ve never seen it before.\nNext, because I don’t like accessing the device over a name that can change, I will map this specific LiDAR to a static name. Using the dmesg output information above, I run\n$ echo 'SUBSYSTEM==\"tty\", ATTRS{idVendor}==\"10c4\", ATTRS{idProduct}==\"ea60\", MODE:=\"0660\", GROUP:=\"dialout\", SYMLINK+=\"rpLiDAR\"' | sudo tee /etc/udev/rules.d/99-rpLiDAR.rules $ sudo udevadm control --reload-rules $ sudo udevadm trigger Now, anytime I plug the LiDAR in, I can access it on /dev/rpLiDAR, even if something else happened to attach to ttyUSB0 first.\nSince I’ve already decided I’ll use Python and the PyRPlidar package, it is prudent for us to set up a Python virtual environment and install support libraries. There are too many “good enough” ways to manage Python virtual environments to go into details here. Suffice it to say, use Python virtual environments. Solely because this is the computer I am on, I will proceed with Anaconda and the conda command. I used the following commands, with output removed:\n$ conda create -n rpLiDAR python=3.11 $ conda install pytest pyserial panel hvplot And the library I chose to use is not in Anaconda, so I will use pip to install it\n$ pip install PyRPlidar First LiDAR Comms I’m a believer in Gall’s Law:\nA complex system that works is invariably found to have evolved from a simple system that worked.\nWith Galls’ Law in mind, I chose to connect to the LiDAR as quickly as possible and get information back. Hackers will start with Minicom. Most people in the modern era working with these tools will likely fire up Jupyter Lab and iterate from simple working to more complex working. For this work, I chose to use Emacs org-mode.\nThe first question to answer is can I communicate with the device at all?\nSo, moving over to Python and focusing on communication through my chosen library, I run the following code:\nfrom PyRPlidar import PyRPlidar # this config info be used a lot so break it out early rp_cfg = { 'port': '/dev/rpLiDAR', 'baudrate': 115200, 'timeout': 3, } LiDAR = PyRPlidar() LiDAR.connect(**rp_cfg) info = LiDAR.get_info() print(f\"LiDAR information:\\n{info}\\n\") health = LiDAR.get_health() print(f\"LiDAR health:\\n{health}\\n\") samplerate = LiDAR.get_samplerate() print(f\"LiDAR sample rate: {samplerate}\\n\") scan_modes = LiDAR.get_scan_modes() print(\"Scan modes:\\n\") for scan_mode in scan_modes: print(scan_mode) LiDAR.disconnect() Executing this yields the following (successful!) output:\nPyRPlidar Info : device is connected LiDAR information: {'model': 40, 'firmware_minor': 25, 'firmware_major': 1, 'hardware': 5, 'serialnumber': 'B4889AF2C1EA9FC0BEEB9CF33B5B3200'} LiDAR health: {'status': 0, 'error_code': 0} LiDAR sample rate: {'t_standard': 500, 't_express': 250} {'name': 'Standard', 'max_distance': 3072, 'us_per_sample': 128000, 'ans_type': 'NORMAL'} {'name': 'Express', 'max_distance': 3072, 'us_per_sample': 64000, 'ans_type': 'CAPSULED'} {'name': 'Boost', 'max_distance': 3072, 'us_per_sample': 32000, 'ans_type': 'ULTRA_CAPSULED'} Scan modes: {'name': 'Standard', 'max_distance': 3072, 'us_per_sample': 128000, 'ans_type': 'NORMAL'} {'name': 'Express', 'max_distance': 3072, 'us_per_sample': 64000, 'ans_type': 'CAPSULED'} {'name': 'Boost', 'max_distance': 3072, 'us_per_sample': 32000, 'ans_type': 'ULTRA_CAPSULED'} PyRPlidar Info : device is disconnected After confirming the library, which has not been maintained in quite a while, still works with my LiDAR, it was time to capture some scans.\nimport time def simple_scan(rp_cfg): LiDAR = PyRPlidar() LiDAR.connect(**rp_cfg) try: samplerate = LiDAR.get_samplerate() LiDAR.set_motor_pwm(samplerate.t_standard) time.sleep(2) scan_generator = LiDAR.force_scan() for count, scan in enumerate(scan_generator()): print(count, scan) if count == 360: break finally: LiDAR.stop() LiDAR.set_motor_pwm(0) LiDAR.disconnect() simple_scan(rp_cfg) Running this in my org-mode source code block returns:\nPyRPlidar Info : device is connected 0 {'start_flag': False, 'quality': 0, 'angle': 312.65625, 'distance': 0.0} 1 {'start_flag': False, 'quality': 15, 'angle': 337.1875, 'distance': 0.0} 2 {'start_flag': False, 'quality': 15, 'angle': 332.234375, 'distance': 929.0} 3 {'start_flag': False, 'quality': 15, 'angle': 333.765625, 'distance': 921.0} 4 {'start_flag': False, 'quality': 15, 'angle': 335.203125, 'distance': 912.5} 5 {'start_flag': False, 'quality': 15, 'angle': 336.640625, 'distance': 905.75} 6 {'start_flag': False, 'quality': 15, 'angle': 338.1875, 'distance': 897.5} 7 {'start_flag': False, 'quality': 15, 'angle': 339.6875, 'distance': 871.5} 8 {'start_flag': False, 'quality': 15, 'angle': 341.21875, 'distance': 872.0} 9 {'start_flag': False, 'quality': 0, 'angle': 349.0, 'distance': 0.0} 10 {'start_flag': False, 'quality': 0, 'angle': 350.484375, 'distance': 0.0} 11 {'start_flag': False, 'quality': 0, 'angle': 351.953125, 'distance': 0.0} 12 {'start_flag': False, 'quality': 8, 'angle': 347.578125, 'distance': 655.0} 13 {'start_flag': False, 'quality': 8, 'angle': 349.09375, 'distance': 648.75} 14 {'start_flag': False, 'quality': 7, 'angle': 350.59375, 'distance': 661.0} 15 {'start_flag': False, 'quality': 0, 'angle': 357.859375, 'distance': 0.0} 16 {'start_flag': True, 'quality': 0, 'angle': 359.34375, 'distance': 0.0} 17 {'start_flag': False, 'quality': 15, 'angle': 0.828125, 'distance': 0.0} 18 {'start_flag': False, 'quality': 0, 'angle': 2.296875, 'distance': 0.0} 19 {'start_flag': False, 'quality': 15, 'angle': 356.78125, 'distance': 1404.5} 20 {'start_flag': False, 'quality': 0, 'angle': 5.25, 'distance': 0.0} 21 {'start_flag': False, 'quality': 15, 'angle': 359.65625, 'distance': 1591.0} 22 {'start_flag': False, 'quality': 15, 'angle': 8.21875, 'distance': 0.0} 23 {'start_flag': False, 'quality': 15, 'angle': 9.6875, 'distance': 0.0} 24 {'start_flag': False, 'quality': 15, 'angle': 3.484375, 'distance': 4439.25} 25 {'start_flag': False, 'quality': 0, 'angle': 12.640625, 'distance': 0.0} 26 {'start_flag': False, 'quality': 15, 'angle': 6.546875, 'distance': 3401.25} 27 {'start_flag': False, 'quality': 15, 'angle': 8.015625, 'distance': 3413.0} 28 {'start_flag': False, 'quality': 15, 'angle': 9.5, 'distance': 3428.0} [...] This was also a success! Looking through the output snippet, you can see there is a lot of jitter in the angle measurements, and the resolution seems incorrect given the earlier mentioned 0.9° resolution. That’s of no concern. First, I captured the first few ranges off the device, it’s not even up to full steady state speed. Second, there will always be jitter in LiDAR measurements from these devices: they will be especially noticeable when there is a large difference in the ranges. This property can, however, be notable for algorithms working with the LiDAR range data.\nDiving into Holoviews and Panel Now it’s time to move onto the side quest on getting this device operating. As mentioned at the top of this post, I wanted to explore using Holoviews as the visualization interface and I will do so using Bokeh as the backend. I will put the visualization onto a Panel dashboard, along with some other basic information. My objective is to get hands on with the libraries and to see how they perform with a sensor streaming at around 4000 Hz – admittedly this is not a simple ask for a dashboard running in a web browser.\nLiDAR Producer Loop To get started, and knowing I will be using this LiDAR later, I decided to proceed with a producer-consumer architecture for my dashboard. This will ensure I can copy over my producer code later without (significant) additional work.\nimport threading import time from queue import Queue from typing import Any, Dict, Union from PyRPlidar import PyRPlidar from src.mock_rpLiDAR import MockRPLiDAR MOTOR_STOP_PWM = 0 CMD_DELAY = 1 MOTOR_DELAY = 2 def create_LiDAR_instance(config: Dict[str, Any], scan_queue: Queue[Any]) -\u003e \"RPLiDAR\": if config[\"mock_LiDAR\"][\"use_mock\"]: LiDAR = MockRPLiDAR() else: LiDAR = PyRPlidar() hw_cfg = config.get(\"rpLiDAR\", {}) return RPLiDAR(LiDAR, scan_queue, hw_cfg) class RPLiDAR: def __init__( self, LiDAR: Union[\"MockRPLiDAR\", \"PyRPlidar\"], scan_queue: Queue, hw_cfg: Dict[str, Any], ) -\u003e None: self.LiDAR = LiDAR self.hw_cfg = hw_cfg self.is_connected = False self.is_configured = False self.is_scanning = False self.scan_queue = scan_queue def __enter__(self) -\u003e \"RPLiDAR\": self._connect() self._configure() return self def __exit__(self, exc_type: Any, exc_value: Any, traceback: Any) -\u003e None: if self.is_scanning: self.stop_scan() self._disconnect() def _connect(self) -\u003e None: self.LiDAR.connect(**self.hw_cfg) self.is_connected = True def _configure(self) -\u003e None: try: samplerate = self.LiDAR.get_samplerate() # these scanners support standard and express self.LiDAR.set_motor_pwm(samplerate.t_standard) time.sleep(MOTOR_DELAY) self.is_configured = True except Exception as e: self.LiDAR._disconnect() raise e def _disconnect(self) -\u003e None: self.LiDAR.set_motor_pwm(MOTOR_STOP_PWM) self.is_configured = False self.LiDAR.disconnect() time.sleep(CMD_DELAY) self.is_connected = False def start_scan(self) -\u003e None: if not self.is_connected or not self.is_configured: raise RuntimeError(\"Not connected to the device. Cannot start scanning.\") self.is_scanning = True self.scan_thread = threading.Thread(target=self._fetch_scans) self.scan_thread.start() def stop_scan(self) -\u003e None: self.is_scanning = False self.scan_thread.join() self.LiDAR.stop() time.sleep(MOTOR_DELAY) def _fetch_scans(self) -\u003e None: scan_generator = self.LiDAR.force_scan() for count, scan in enumerate(scan_generator()): if not self.is_scanning: break # scan is an object with methods for angle, distance, and quality scan.timestamp = time.time_ns() * 1e-9 # discard the oldest data if we fill the queue if self.scan_queue.qsize() \u003e= self.scan_queue.maxsize: _ = self.scan_queue.get_nowait() # Remove the oldest item. # print(\"Warning: Queue is full. Replacing oldest data.\") self.scan_queue.put_nowait(scan) Perhaps most notable in this code is the bits about a “mock” LiDAR. There are several reasons I took the time to make a mock device.\nI often develop on different computers Sometimes you want to be able to replay “standard” or “interesting” data sets you’ve captured It can help isolate hardware issues from software issues, especially later on in a project I highly recommend using a mock device approach when working with hardware. In this case, I kept the mock interface extremely simple and can develop it out more, later if I need more features.\nimport itertools import pickle import time from collections import namedtuple from typing import Any, Generator mock_scans_file = \"src/mock_scans.pkl\" MockSampleRate = namedtuple(\"MockSampleRate\", [\"t_standard\", \"t_express\"]) MockDeviceInfo = namedtuple( \"MockDeviceInfo\", [\"model\", \"firmware_minor\", \"firmware_major\", \"hardware\", \"serialnumber\"], ) MockDeviceHealth = namedtuple(\"MockDeviceHealth\", [\"status\", \"error_code\"]) SCAN_RATE = 4000 # Hz SCAN_DELAY = 1 / SCAN_RATE class MockRPLiDAR: def __init__(self) -\u003e None: with open(mock_scans_file, \"rb\") as f: self.mock_scans = pickle.load(f) def connect(self, *args: Any, **kwargs: Any) -\u003e None: pass def get_info(self) -\u003e MockDeviceInfo: return MockDeviceInfo( model=40, firmware_minor=25, firmware_major=1, hardware=5, serialnumber=\"FAKE9AF2C1EA9FC0BEEB9CF33B5BFAKE\", ) def get_health(self) -\u003e MockDeviceHealth: return MockDeviceHealth(status=0, error_code=0) def get_samplerate(self, *args: Any, **kwargs: Any) -\u003e MockSampleRate: return MockSampleRate(t_standard=500, t_express=250) def set_motor_pwm(self, *args: Any, **kwargs: Any) -\u003e None: pass def force_scan(self, *args: Any, **kwargs: Any) -\u003e Generator: def mock_scan_generator(): # Loop through mock_scan_data indefinitely for scan in itertools.cycle(self.mock_scans): start_time = time.perf_counter() yield scan elapsed = time.perf_counter() - start_time sleep_time = SCAN_DELAY - elapsed # get pretty close to 4 kHz if sleep_time \u003e 0: time.sleep(sleep_time) return mock_scan_generator def stop(self, *args: Any, **kwargs: Any) -\u003e None: pass def disconnect(self, *args: Any, **kwargs: Any) -\u003e None: pass I also set up pytest for some happy path tests and basic unit tests; even for hobby projects I find automated tests incredibly valuable and worth the time to implement. I also highly recommend anyone working with hardware takes the time to add testing, even for hobby projects. It can save enormous amounts of time when you want to improve the code or add functionality, especially after long breaks you often take on hobby projects.\nDashboard Consumer Loop Again, following Gall’s law, I wanted to get something. anything working with Panel before jumping into visualizations. The first things I chose to try and display were:\nupdate loop timing queue size table of the most recent 400 values, which is roughly one full LiDAR rotation. A 20 Hz update rate was targeted. That means this information is going to update fast so it’s more about watching it stream by and getting a feel and answering questions such as “does my queue back up and start dropping data?\nNow, I admit, I didn’t spend a lot of time with the documentation before starting this. I quickly discovered that Bokeh does not support polar plots! That’s really unfortunate, since I do use them frequently and they are the natural way to plot LiDAR data. So in the following code, and in the previous gif, I chose to convert polar coordinates to Cartesian coordinates.\nAdding the simple visualization was quite easy from here. The code of how it was all achieved was:\nimport queue import threading import time import holoviews as hv import numpy as np import pandas as pd import panel as pn from bokeh.palettes import Viridis256 hv.extension(\"bokeh\") class Dashboard: def __init__( self, scan_queue: queue.Queue, shutdown_event: threading.Event ) -\u003e None: self.scan_queue = scan_queue self.shutdown_event = shutdown_event self.scan_cols = [\"Timestamp\", \"x\", \"y\", \"Quality\"] self.recent_scans = pd.DataFrame(columns=self.scan_cols) self.table = pn.widgets.DataFrame(self.recent_scans, width=500, height=400) self.queue_size_display = pn.widgets.StaticText(name=\"Queue Size\", value=\"0\") self.update_loop_time = pn.widgets.StaticText( name=\"Update Loop (ms)\", value=\"0\" ) self.data_stream = hv.streams.Pipe(data=pd.DataFrame(columns=self.scan_cols)) self.plot = hv.DynamicMap(self.create_plot, streams=[self.data_stream]) self.plot = self.plot.options( framewise=True, width=800, height=600, tools=[\"hover\"] ) num_qualities = 16 sampled_colors = [ Viridis256[int(i)] for i in np.linspace(0, 255, num_qualities) ] self.quality_colors = { str(i): color for i, color in zip(range(num_qualities), sampled_colors) } def create_plot(self, data: pd.DataFrame) -\u003e hv.plotting.element.Scatter: if data is None or data.empty: return hv.Scatter([]) else: return hv.Scatter(data, kdims=[\"x\"], vdims=[\"y\", \"Quality\"]).opts( size=5, color=\"Quality\", cmap=self.quality_colors ) def update_dashboard(self) -\u003e None: batch = [] while not self.scan_queue.empty(): scan = self.scan_queue.get_nowait() rads = np.radians(scan.angle) x = scan.distance * np.cos(rads) y = scan.distance * np.sin(rads) batch.append([scan.timestamp, x, y, str(scan.quality)]) if batch: # Only concatenate if new data exists new_df = pd.DataFrame(batch, columns=self.scan_cols) self.recent_scans = pd.concat([self.recent_scans, new_df]).tail(400) self.table.value = self.recent_scans self.data_stream.send(self.recent_scans) self.queue_size_display.value = str(len(batch)) def run(self) -\u003e None: # Create and display the dashboard view view = self.view() server = pn.serve(view, show=True, threaded=True) # Update loop target_refresh = 0.05 # 20 Hz try: while not self.shutdown_event.is_set(): start_time = time.perf_counter() self.update_dashboard() elapsed_time = time.perf_counter() - start_time self.update_loop_time.value = f\"{elapsed_time * 1000: .2f}\" sleep_time = target_refresh - elapsed_time if sleep_time \u003e 0: time.sleep(sleep_time) finally: server.stop() def view(self) -\u003e pn.Column: return pn.Column( self.update_loop_time, self.queue_size_display, self.plot, self.table ) Additionally, I need a script to call both the producer and consumer loops, which I will save as main.py.\nimport threading from queue import Queue from src.config_util import load_config from src.dashboard import Dashboard from src.rpLiDAR_interface import RPLiDAR, create_LiDAR_instance shutdown_event = threading.Event() config = load_config() def main() -\u003e None: scan_queue = Queue(maxsize=config[\"queue\"][\"size\"]) try: with create_LiDAR_instance(config, scan_queue) as rpLiDAR: rpLiDAR.start_scan() print(\"Starting dashboard\") dashboard = Dashboard(scan_queue, shutdown_event) print(\"Serving dashboard\") dashboard.run() print(\"Dashboard exited\") except KeyboardInterrupt: print(\"KeyboardInterrupt detected. Shutting down.\") shutdown_event.set() rpLiDAR.stop_scan() except Exception as e: print(f\"An error occurred: {e}\") shutdown_event.set() rpLiDAR.stop_scan() if __name__ == \"__main__\": main() And with the plot added, the dashboard became:\nThe results are quite good. The gif format doesn’t adequately capture how smooth and quickly it runs, but it was excellent. My queue size remains small and my update loop is running more than fast enough to keep up with my chosen update rate. The visualization isn’t perfect and needs work – the XY coordinates can adjust in and out wildly with outliers or changes in scans and the legend isn’t sorted with values coming in and out.\nThe code to implement a dashboard in Panel and a visualization using Holoviws is straightforward and effective. I would say, for those learning, there are two trickier things to notice:\nsince I don’t expect all scans to have all quality values (0-15) it is worth mapping colors to values explicitly so, for each refresh, the mapping doesn’t change on us.\nTiming is important and I’m not sure how long things would take to execute. I expected it could take some fiddling. I know running in a browser is going to be limiting regardless and felt like aiming for 20 Hz was ambitious. As a result, I implemented a timing loop that accounts for the length of time update_dashboard() takes to execute. While not strictly necessary for this project, adopting good practices will pay off in the long run.\nI will also admit that one could argue I could have more cleanly handled exiting by using threading.Event() for both the dashboard and the rplidar interface. When I arrived at this point I didn’t bother to adjust anything since I knew I wouldn’t be keeping the dashboard code for future projects and the interface would work well, as it was, in my next project.\nThere was, however, more latency than I expected between an object moving in my environment and it being displayed as moving on the plot. Again, the queue is being emptied quickly, the update loop is running within my desired bounds, and I know this LiDAR itself does not have this observed latency. Therefore, I suspect it is a limitation of using a browser to render such visualizations.There is a reason when I’ve needed custom visualization tools for such applications professionally I have typically turned to using Qt. I’ll likely profile all this and get to the bottom of it in the future.\nKey Learnings and Conclusion Although the work is incomplete and there are a number of very obvious ways I can continue to refine this, it’s worth reflecting on the experience so far. Setting up the hardware went smoothly and it performed as expected. I was able to easily develop an interface for it that will be useful for many projects and set up a mock interface and some testing as well.\nIn reflecting on my exploration of Holoviews and Panel for visualizing LiDAR data in real-time, I found both tools to offer unique advantages that complement my experiences with other Python-based prototyping tools such as Streamlit and Plotly. Streamlit has been my go-to for rapidly developing data-driven prototype applications, thanks to its straightforward interaction model. Plotly, within Streamlit, has served well for creating interactive plots, leveraging its extensive features and ease of use. However, the exploration into Panel and Holoviews, particularly with the Bokeh backend, revealed a flexible and efficient framework for building interactive applications, especially beneficial for complex tasks requiring state maintenance and more granular control over data updates without full page reloads.\nThe limitation of Bokeh, such as its lack of native support for polar plots, was a notable drawback in the context of LiDAR data visualization. This constraint necessitated a workaround by converting polar coordinates to Cartesian, which, while effective, underscored that it is a community driven library that is under active development and still does not support the wide variety of plots we use in engineering and scientific contexts. Although I didn’t delve into detailed performance profiling, the real-time responsiveness of the dashboard fell short of my expectations. Despite the efficiency in data handling and update mechanisms, the visualization exhibited more latency than desirable for real-time applications. I don’t blame Panel or Holoviews, but I fully admit that there is almost certainly a fundamental limit to pushing this much information through a web browser.\nWith all that said, supporting and experimenting with community-driven open-source solutions like Holoviews and Panel is, in my opinion, imperative. Free/Libre Open Source Software has changed my life, and I know I’m not alone in that. For personal projects, I will continue to use and, hopefully, contribute to the excellent Holoviz ecosystem.\nContinuing the Conversation Let’s shape the future together: if you’re willing to question assumptions and carve out unique paths towards progress, I’m eager to partner with you.\nThe conversation shouldn’t stop here. Every situation is unique and I value your experiences. I invite you to reach out to me directly, for feedback on this article or to start a dialogue on how we can transform your challenges into opportunities.\nContact me.\n","wordCount":"3720","inLanguage":"en","datePublished":"2023-08-09T17:25:51-04:00","dateModified":"2023-08-09T17:25:51-04:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.dwblab.com/posts/real-time-lidar-data-visualization-holoviews-panel/"},"publisher":{"@type":"Organization","name":"dwblab - Home of Douglas Breault: Innovative Leadership and Engineering","logo":{"@type":"ImageObject","url":"https://www.dwblab.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.dwblab.com/ accesskey=h title="dwblab (Alt + H)"><img src=https://www.dwblab.com/apple-touch-icon.png alt aria-label=logo height=35>dwblab</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.dwblab.com/archives title=Archives><span>Archives</span></a></li><li><a href=https://www.dwblab.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://www.dwblab.com/about title=About><span>About</span></a></li><li><a href=https://www.dwblab.com/contact title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.dwblab.com/>Home</a>&nbsp;»&nbsp;<a href=https://www.dwblab.com/posts/>Writings</a></div><h1 class="post-title entry-hint-parent">Real Time LiDAR Data Visualization With Holoviews and Panel</h1><div class=post-description>This post explores creating a Python dashboard for real-time LiDAR data visualization using Holoviews and Panel. I have used both Streamlit and Plotly for many robotics projects, but the Holoviz ecosystem has intrigued me for many reasons.</div><div class=post-meta><span title='2023-08-09 17:25:51 -0400 EDT'>August 9, 2023</span>&nbsp;·&nbsp;18 min</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#setting-up-the-lidar-system>Setting Up the LiDAR System</a></li><li><a href=#first-lidar-comms>First LiDAR Comms</a></li><li><a href=#diving-into-holoviews-and-panel>Diving into Holoviews and Panel</a><ul><li><a href=#lidar-producer-loop>LiDAR Producer Loop</a></li><li><a href=#dashboard-consumer-loop>Dashboard Consumer Loop</a></li></ul></li><li><a href=#key-learnings-and-conclusion>Key Learnings and Conclusion</a></li><li><a href=#continuing-the-conversation>Continuing the Conversation</a></li></ul></nav></div></details></div><div class=post-content><p>Over my two decades of experience in robotics and engineering, I&rsquo;ve found LiDARs to be integral part of how I&rsquo;ve used robotic systems. I&rsquo;ve used LiDARs for applications ranging from localization and mapping to obstacle avoidance, safety systems, and ground truth tracking. Most of the LiDARs I&rsquo;ve used have been industrial grade devices, and today I have a hobbyist grade LiDAR that I need to get running before I put it on a home project. This presents me with an opportunity to finally explore Holoviews and Panel using some high-frequency real-time sensor data.</p><p>In exploring new technologies and tools within the data visualization and dashboard creation space, my curiosity is continually drawn to Holoviews and Panel. <a href=https://holoviews.org/>Holoviews</a> is a Python library designed to simplify data visualization and is capable of using different backends, including Matplotlib and Bokeh. <a href=https://panel.holoviz.org/>Panel</a> is, like Holoviews, part of the Holoviz system and is a high-level dashboarding solution, allowing users
to create interactive, web-based applications.</p><p>What sets Holoviews and Panel apart from commercial options like Plotly and Streamlit is their robust, community-driven open-source ethos. For personal projects, I will always give preference to community driven Free/Libre Open Source Software.</p><p>The technical underpinnings of Panel also offer a compelling case for its adoption over alternatives. My experience with Streamlit, while incredibly positive, has been tempered by its stateless model. Streamlit’s approach, where the app&rsquo;s state is not preserved between user interactions, causing the entire script to rerun with every action, can be less than ideal. This model often results in performance bottlenecks, particularly in data-intensive applications common in my work. Panel, on the other hand, utilizes a stateful model, allowing for partial updates and, crucially, more efficient handling of live data streams.</p><p>Testing this LiDAR gave me a perfect excuse to explore the capabilities of Holoviews and Panel. I am particularly interested in how the plotting interfaces feel, how much boilerplate Panel needs to get something running, and how performant the visualizations and dashboards can be with a real-time data stream.</p><h2 id=setting-up-the-lidar-system>Setting Up the LiDAR System<a hidden class=anchor aria-hidden=true href=#setting-up-the-lidar-system>#</a></h2><figure><img loading=lazy src=/posts/real-time-lidar-data-visualization-holoviews-panel/rplidar%20a2m8-cropped.jpeg alt="The Slamtec A2M8 LiDAR, sitting on a desk, ready to be plugged in and used."></figure><p>The LiDAR is a Slamtec RPLiDAR A2M8. It is a 2D 360° scanner with an 8-meter range. It can scan at 5-15 Hz and has an angular resolution of 0.9° at 10 Hz. When working with any sensor, the first thing you should do is pull up the data sheets and manuals! In this case, it is a straight-forward and easy to use sensor that has a number of options for using it. There&rsquo;s a ROS (Robotic Operating System) driver, which appears to be the most popular way to interface, but that&rsquo;s not appropriate for my project. I don&rsquo;t <em>need</em> to use a library, but <a href=https://github.com/Hyun-je/pyrplidar>PyRPlidar</a> appears to be a solid implementation of the protocol and will save us time getting started.</p><p>The first step is to plug the scanner into the computer and see if it shows up. Using a Linux computer, which all instructions will assume, the most basic way to check is to run <code>$ sudo dmesg</code> to get some information about the device and see where it has attached.</p><pre tabindex=0><code class=language-shellsession data-lang=shellsession>$ sudo dmesg
[...]
[86398.0045891] usb 5-4: New USB device found, idVendor=10c4, idProduct=ea60, bcdDevice= 1.00
[86398.045898] usb 5-4: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[86398.045901] usb 5-4: Product: CP2102 USB to UART Bridge Controller
[86398.045905] usb 5-4: Manufacturer: Silicon Labs
[86398.045908] usb 5-4: SerialNumber: 0001
[86398.075170] usbcore: registered new interface driver usbserial_generic
[86398.075183] usbserial: USB Serial support registered for generic
[86398.076474] usbcore: registered new interface driver cp210x
[86398.076486] usbserial: USB Serial support registered for cp210x
[86398.076525] cp210x 5-4:1.0: cp210x converter detected
[86398.080941] usb 5-4: cp210x converter now attached to ttyUSB0
</code></pre><p>Since I am accessing the device on a <code>tty*</code> I need to be in the <code>dialout</code> group. I run <code>$ groups</code> and see that my user is not in this group. I add it with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo usermod -aG dialout <span class=nv>$USER</span>
</span></span></code></pre></div><p>It is important to note that this change does not take effect immediately. Shells, and even your GUI login, need to be restarted for changes to your user&rsquo;s groups to take effect. You can forge ahead in your open shell on most systems by calling <code>$ newgrp</code>. This step often trips up many people, especially those not fluent in Linux. This is not hard stuff but can be quite tricky if you&rsquo;ve never seen it before.</p><p>Next, because I don’t like accessing the device over a name that can change, I will map this specific LiDAR to a static name. Using the <code>dmesg</code> output information above, I run</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;SUBSYSTEM==&#34;tty&#34;, ATTRS{idVendor}==&#34;10c4&#34;, ATTRS{idProduct}==&#34;ea60&#34;, MODE:=&#34;0660&#34;, GROUP:=&#34;dialout&#34;, SYMLINK+=&#34;rpLiDAR&#34;&#39;</span> <span class=p>|</span> sudo tee /etc/udev/rules.d/99-rpLiDAR.rules
</span></span><span class=line><span class=cl>$ sudo udevadm control --reload-rules
</span></span><span class=line><span class=cl>$ sudo udevadm trigger
</span></span></code></pre></div><p>Now, anytime I plug the LiDAR in, I can access it on <code>/dev/rpLiDAR</code>, even if something else happened to attach to <code>ttyUSB0</code> first.</p><p>Since I&rsquo;ve already decided I&rsquo;ll use Python and the PyRPlidar package, it is prudent for us to set up a Python virtual environment and install support libraries. There are too many “good enough” ways to manage Python virtual environments to go into details here. Suffice it to say, use Python virtual environments. Solely because this is the computer I am on, I will proceed with Anaconda and the <code>conda</code> command. I used the following commands, with output removed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ conda create -n rpLiDAR <span class=nv>python</span><span class=o>=</span>3.11
</span></span><span class=line><span class=cl>$ conda install pytest pyserial panel hvplot
</span></span></code></pre></div><p>And the library I chose to use is <em>not</em> in Anaconda, so I will use pip to install it</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ pip install PyRPlidar
</span></span></code></pre></div><h2 id=first-lidar-comms>First LiDAR Comms<a hidden class=anchor aria-hidden=true href=#first-lidar-comms>#</a></h2><p>I&rsquo;m a believer in <a href="https://en.wikipedia.org/wiki/John_Gall_(author)#Gall's_law">Gall&rsquo;s Law</a>:</p><blockquote><p>A complex system that works is invariably found to have evolved from a simple system that worked.</p></blockquote><p>With Galls&rsquo; Law in mind, I chose to connect to the LiDAR as quickly as possible and get information back. Hackers will start with Minicom. Most people in the modern era working with these tools will likely fire up Jupyter Lab and iterate from simple working to more complex working. For this work, I chose to use Emacs org-mode.</p><p>The first question to answer is can I communicate with the device at all?</p><p>So, moving over to Python and focusing on communication through my chosen library, I run the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PyRPlidar</span> <span class=kn>import</span> <span class=n>PyRPlidar</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># this config info be used a lot so break it out early</span>
</span></span><span class=line><span class=cl><span class=n>rp_cfg</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;port&#39;</span><span class=p>:</span> <span class=s1>&#39;/dev/rpLiDAR&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;baudrate&#39;</span><span class=p>:</span> <span class=mi>115200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;timeout&#39;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>LiDAR</span> <span class=o>=</span> <span class=n>PyRPlidar</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>LiDAR</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>rp_cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>info</span> <span class=o>=</span> <span class=n>LiDAR</span><span class=o>.</span><span class=n>get_info</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LiDAR information:</span><span class=se>\n</span><span class=si>{</span><span class=n>info</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>health</span> <span class=o>=</span> <span class=n>LiDAR</span><span class=o>.</span><span class=n>get_health</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LiDAR health:</span><span class=se>\n</span><span class=si>{</span><span class=n>health</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>samplerate</span> <span class=o>=</span> <span class=n>LiDAR</span><span class=o>.</span><span class=n>get_samplerate</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;LiDAR sample rate: </span><span class=si>{</span><span class=n>samplerate</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>scan_modes</span> <span class=o>=</span> <span class=n>LiDAR</span><span class=o>.</span><span class=n>get_scan_modes</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Scan modes:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>scan_mode</span> <span class=ow>in</span> <span class=n>scan_modes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>scan_mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>LiDAR</span><span class=o>.</span><span class=n>disconnect</span><span class=p>()</span>
</span></span></code></pre></div><p>Executing this yields the following (successful!) output:</p><pre tabindex=0><code class=language-shellsession data-lang=shellsession>PyRPlidar Info : device is connected
LiDAR information:
{&#39;model&#39;: 40, &#39;firmware_minor&#39;: 25, &#39;firmware_major&#39;: 1, &#39;hardware&#39;: 5, &#39;serialnumber&#39;: &#39;B4889AF2C1EA9FC0BEEB9CF33B5B3200&#39;}
LiDAR health:
{&#39;status&#39;: 0, &#39;error_code&#39;: 0}
LiDAR sample rate: {&#39;t_standard&#39;: 500, &#39;t_express&#39;: 250}
{&#39;name&#39;: &#39;Standard&#39;, &#39;max_distance&#39;: 3072, &#39;us_per_sample&#39;: 128000, &#39;ans_type&#39;: &#39;NORMAL&#39;}
{&#39;name&#39;: &#39;Express&#39;, &#39;max_distance&#39;: 3072, &#39;us_per_sample&#39;: 64000, &#39;ans_type&#39;: &#39;CAPSULED&#39;}
{&#39;name&#39;: &#39;Boost&#39;, &#39;max_distance&#39;: 3072, &#39;us_per_sample&#39;: 32000, &#39;ans_type&#39;: &#39;ULTRA_CAPSULED&#39;}
Scan modes:
{&#39;name&#39;: &#39;Standard&#39;, &#39;max_distance&#39;: 3072, &#39;us_per_sample&#39;: 128000, &#39;ans_type&#39;: &#39;NORMAL&#39;}
{&#39;name&#39;: &#39;Express&#39;, &#39;max_distance&#39;: 3072, &#39;us_per_sample&#39;: 64000, &#39;ans_type&#39;: &#39;CAPSULED&#39;}
{&#39;name&#39;: &#39;Boost&#39;, &#39;max_distance&#39;: 3072, &#39;us_per_sample&#39;: 32000, &#39;ans_type&#39;: &#39;ULTRA_CAPSULED&#39;}
PyRPlidar Info : device is disconnected
</code></pre><p>After confirming the library, which has not been maintained in quite a while, still works with my LiDAR, it was time to capture some scans.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>simple_scan</span><span class=p>(</span><span class=n>rp_cfg</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>LiDAR</span> <span class=o>=</span> <span class=n>PyRPlidar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>LiDAR</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=n>rp_cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>samplerate</span> <span class=o>=</span> <span class=n>LiDAR</span><span class=o>.</span><span class=n>get_samplerate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>LiDAR</span><span class=o>.</span><span class=n>set_motor_pwm</span><span class=p>(</span><span class=n>samplerate</span><span class=o>.</span><span class=n>t_standard</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>scan_generator</span> <span class=o>=</span> <span class=n>LiDAR</span><span class=o>.</span><span class=n>force_scan</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>count</span><span class=p>,</span> <span class=n>scan</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>scan_generator</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>count</span><span class=p>,</span> <span class=n>scan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>count</span> <span class=o>==</span> <span class=mi>360</span><span class=p>:</span> <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>LiDAR</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>LiDAR</span><span class=o>.</span><span class=n>set_motor_pwm</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>LiDAR</span><span class=o>.</span><span class=n>disconnect</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>simple_scan</span><span class=p>(</span><span class=n>rp_cfg</span><span class=p>)</span>
</span></span></code></pre></div><p>Running this in my org-mode source code block returns:</p><pre tabindex=0><code class=language-shellsession data-lang=shellsession>PyRPlidar Info : device is connected
0 {&#39;start_flag&#39;: False, &#39;quality&#39;: 0, &#39;angle&#39;: 312.65625, &#39;distance&#39;: 0.0}
1 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 337.1875, &#39;distance&#39;: 0.0}
2 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 332.234375, &#39;distance&#39;: 929.0}
3 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 333.765625, &#39;distance&#39;: 921.0}
4 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 335.203125, &#39;distance&#39;: 912.5}
5 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 336.640625, &#39;distance&#39;: 905.75}
6 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 338.1875, &#39;distance&#39;: 897.5}
7 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 339.6875, &#39;distance&#39;: 871.5}
8 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 341.21875, &#39;distance&#39;: 872.0}
9 {&#39;start_flag&#39;: False, &#39;quality&#39;: 0, &#39;angle&#39;: 349.0, &#39;distance&#39;: 0.0}
10 {&#39;start_flag&#39;: False, &#39;quality&#39;: 0, &#39;angle&#39;: 350.484375, &#39;distance&#39;: 0.0}
11 {&#39;start_flag&#39;: False, &#39;quality&#39;: 0, &#39;angle&#39;: 351.953125, &#39;distance&#39;: 0.0}
12 {&#39;start_flag&#39;: False, &#39;quality&#39;: 8, &#39;angle&#39;: 347.578125, &#39;distance&#39;: 655.0}
13 {&#39;start_flag&#39;: False, &#39;quality&#39;: 8, &#39;angle&#39;: 349.09375, &#39;distance&#39;: 648.75}
14 {&#39;start_flag&#39;: False, &#39;quality&#39;: 7, &#39;angle&#39;: 350.59375, &#39;distance&#39;: 661.0}
15 {&#39;start_flag&#39;: False, &#39;quality&#39;: 0, &#39;angle&#39;: 357.859375, &#39;distance&#39;: 0.0}
16 {&#39;start_flag&#39;: True, &#39;quality&#39;: 0, &#39;angle&#39;: 359.34375, &#39;distance&#39;: 0.0}
17 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 0.828125, &#39;distance&#39;: 0.0}
18 {&#39;start_flag&#39;: False, &#39;quality&#39;: 0, &#39;angle&#39;: 2.296875, &#39;distance&#39;: 0.0}
19 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 356.78125, &#39;distance&#39;: 1404.5}
20 {&#39;start_flag&#39;: False, &#39;quality&#39;: 0, &#39;angle&#39;: 5.25, &#39;distance&#39;: 0.0}
21 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 359.65625, &#39;distance&#39;: 1591.0}
22 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 8.21875, &#39;distance&#39;: 0.0}
23 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 9.6875, &#39;distance&#39;: 0.0}
24 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 3.484375, &#39;distance&#39;: 4439.25}
25 {&#39;start_flag&#39;: False, &#39;quality&#39;: 0, &#39;angle&#39;: 12.640625, &#39;distance&#39;: 0.0}
26 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 6.546875, &#39;distance&#39;: 3401.25}
27 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 8.015625, &#39;distance&#39;: 3413.0}
28 {&#39;start_flag&#39;: False, &#39;quality&#39;: 15, &#39;angle&#39;: 9.5, &#39;distance&#39;: 3428.0}
[...]
</code></pre><p>This was also a success! Looking through the output snippet, you can see there is a lot of jitter in the angle measurements, and the resolution seems incorrect given the earlier mentioned 0.9° resolution. That&rsquo;s of no concern. First, I captured the first few ranges off the device, it&rsquo;s not even up to full steady state speed. Second, there will always be jitter in LiDAR measurements from these devices: they will be especially noticeable when there is a large difference in the ranges. This property can, however, be notable for algorithms working with the LiDAR range data.</p><h2 id=diving-into-holoviews-and-panel>Diving into Holoviews and Panel<a hidden class=anchor aria-hidden=true href=#diving-into-holoviews-and-panel>#</a></h2><p>Now it&rsquo;s time to move onto the side quest on getting this device operating. As mentioned at the top of this post, I wanted to explore using Holoviews as the visualization interface and I will do so using Bokeh as the backend. I will put the visualization onto a Panel dashboard, along with some other basic information. My objective is to get hands on with the libraries and to see how they perform with a sensor streaming at around 4000 Hz &ndash; admittedly this is <em>not</em> a simple ask for a dashboard running in a web browser.</p><h3 id=lidar-producer-loop>LiDAR Producer Loop<a hidden class=anchor aria-hidden=true href=#lidar-producer-loop>#</a></h3><p>To get started, and knowing I will be using this LiDAR later, I decided to proceed with a producer-consumer architecture for my dashboard. This will ensure I can copy over my producer code later without (significant) additional work.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>queue</span> <span class=kn>import</span> <span class=n>Queue</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Union</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PyRPlidar</span> <span class=kn>import</span> <span class=n>PyRPlidar</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>src.mock_rpLiDAR</span> <span class=kn>import</span> <span class=n>MockRPLiDAR</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>MOTOR_STOP_PWM</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>CMD_DELAY</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>MOTOR_DELAY</span> <span class=o>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_LiDAR_instance</span><span class=p>(</span><span class=n>config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span> <span class=n>scan_queue</span><span class=p>:</span> <span class=n>Queue</span><span class=p>[</span><span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=s2>&#34;RPLiDAR&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;mock_LiDAR&#34;</span><span class=p>][</span><span class=s2>&#34;use_mock&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>LiDAR</span> <span class=o>=</span> <span class=n>MockRPLiDAR</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>LiDAR</span> <span class=o>=</span> <span class=n>PyRPlidar</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>hw_cfg</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;rpLiDAR&#34;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>RPLiDAR</span><span class=p>(</span><span class=n>LiDAR</span><span class=p>,</span> <span class=n>scan_queue</span><span class=p>,</span> <span class=n>hw_cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RPLiDAR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>LiDAR</span><span class=p>:</span> <span class=n>Union</span><span class=p>[</span><span class=s2>&#34;MockRPLiDAR&#34;</span><span class=p>,</span> <span class=s2>&#34;PyRPlidar&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>scan_queue</span><span class=p>:</span> <span class=n>Queue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>hw_cfg</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span> <span class=o>=</span> <span class=n>LiDAR</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>hw_cfg</span> <span class=o>=</span> <span class=n>hw_cfg</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_connected</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_configured</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_scanning</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scan_queue</span> <span class=o>=</span> <span class=n>scan_queue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__enter__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=s2>&#34;RPLiDAR&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_configure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__exit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>exc_value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>traceback</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_scanning</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>stop_scan</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_disconnect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_connect</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>hw_cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_connected</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_configure</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>samplerate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span><span class=o>.</span><span class=n>get_samplerate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=c1># these scanners support standard and express</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span><span class=o>.</span><span class=n>set_motor_pwm</span><span class=p>(</span><span class=n>samplerate</span><span class=o>.</span><span class=n>t_standard</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>MOTOR_DELAY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>is_configured</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span><span class=o>.</span><span class=n>_disconnect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_disconnect</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span><span class=o>.</span><span class=n>set_motor_pwm</span><span class=p>(</span><span class=n>MOTOR_STOP_PWM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_configured</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span><span class=o>.</span><span class=n>disconnect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>CMD_DELAY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_connected</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>start_scan</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_connected</span> <span class=ow>or</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_configured</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>RuntimeError</span><span class=p>(</span><span class=s2>&#34;Not connected to the device. Cannot start scanning.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_scanning</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scan_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_fetch_scans</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scan_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>stop_scan</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_scanning</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scan_thread</span><span class=o>.</span><span class=n>join</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>MOTOR_DELAY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_fetch_scans</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>scan_generator</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>LiDAR</span><span class=o>.</span><span class=n>force_scan</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>count</span><span class=p>,</span> <span class=n>scan</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>scan_generator</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_scanning</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=c1># scan is an object with methods for angle, distance, and quality</span>
</span></span><span class=line><span class=cl>            <span class=n>scan</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time_ns</span><span class=p>()</span> <span class=o>*</span> <span class=mf>1e-9</span>
</span></span><span class=line><span class=cl>            <span class=c1># discard the oldest data if we fill the queue</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>scan_queue</span><span class=o>.</span><span class=n>qsize</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>scan_queue</span><span class=o>.</span><span class=n>maxsize</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>_</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>scan_queue</span><span class=o>.</span><span class=n>get_nowait</span><span class=p>()</span>  <span class=c1># Remove the oldest item.</span>
</span></span><span class=line><span class=cl>                <span class=c1># print(&#34;Warning: Queue is full. Replacing oldest data.&#34;)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>scan_queue</span><span class=o>.</span><span class=n>put_nowait</span><span class=p>(</span><span class=n>scan</span><span class=p>)</span>
</span></span></code></pre></div><p>Perhaps most notable in this code is the bits about a &ldquo;mock&rdquo; LiDAR. There are several reasons I took the time to make a mock device.</p><ol><li>I often develop on different computers</li><li>Sometimes you want to be able to replay &ldquo;standard&rdquo; or &ldquo;interesting&rdquo; data sets you&rsquo;ve captured</li><li>It can help isolate hardware issues from software issues, especially later on in a project</li></ol><p>I <em>highly</em> recommend using a mock device approach when working with hardware. In this case, I kept the mock interface extremely simple and can develop it out more, later if I need more features.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>namedtuple</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Generator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mock_scans_file</span> <span class=o>=</span> <span class=s2>&#34;src/mock_scans.pkl&#34;</span>
</span></span><span class=line><span class=cl><span class=n>MockSampleRate</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&#34;MockSampleRate&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;t_standard&#34;</span><span class=p>,</span> <span class=s2>&#34;t_express&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>MockDeviceInfo</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;MockDeviceInfo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s2>&#34;model&#34;</span><span class=p>,</span> <span class=s2>&#34;firmware_minor&#34;</span><span class=p>,</span> <span class=s2>&#34;firmware_major&#34;</span><span class=p>,</span> <span class=s2>&#34;hardware&#34;</span><span class=p>,</span> <span class=s2>&#34;serialnumber&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>MockDeviceHealth</span> <span class=o>=</span> <span class=n>namedtuple</span><span class=p>(</span><span class=s2>&#34;MockDeviceHealth&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;status&#34;</span><span class=p>,</span> <span class=s2>&#34;error_code&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SCAN_RATE</span> <span class=o>=</span> <span class=mi>4000</span>  <span class=c1># Hz</span>
</span></span><span class=line><span class=cl><span class=n>SCAN_DELAY</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>SCAN_RATE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MockRPLiDAR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>mock_scans_file</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>mock_scans</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>connect</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_info</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MockDeviceInfo</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>MockDeviceInfo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=mi>40</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>firmware_minor</span><span class=o>=</span><span class=mi>25</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>firmware_major</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>hardware</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>serialnumber</span><span class=o>=</span><span class=s2>&#34;FAKE9AF2C1EA9FC0BEEB9CF33B5BFAKE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_health</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MockDeviceHealth</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>MockDeviceHealth</span><span class=p>(</span><span class=n>status</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>error_code</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_samplerate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MockSampleRate</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>MockSampleRate</span><span class=p>(</span><span class=n>t_standard</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>t_express</span><span class=o>=</span><span class=mi>250</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>set_motor_pwm</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>force_scan</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Generator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>mock_scan_generator</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=c1># Loop through mock_scan_data indefinitely</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>scan</span> <span class=ow>in</span> <span class=n>itertools</span><span class=o>.</span><span class=n>cycle</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mock_scans</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>yield</span> <span class=n>scan</span>
</span></span><span class=line><span class=cl>                <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>                <span class=n>sleep_time</span> <span class=o>=</span> <span class=n>SCAN_DELAY</span> <span class=o>-</span> <span class=n>elapsed</span>  <span class=c1># get pretty close to 4 kHz</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>sleep_time</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>sleep_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mock_scan_generator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>stop</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>disconnect</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span></code></pre></div><p>I also set up pytest for some happy path tests and basic unit tests; even for hobby projects I find automated tests incredibly valuable and worth the time to implement. I also highly recommend anyone working with hardware takes the time to add testing, even for hobby projects. It can save enormous amounts of time when you want to improve the code or add functionality, especially after long breaks you often take on hobby projects.</p><h3 id=dashboard-consumer-loop>Dashboard Consumer Loop<a hidden class=anchor aria-hidden=true href=#dashboard-consumer-loop>#</a></h3><p>Again, following Gall&rsquo;s law, I wanted to get something. anything working with Panel before jumping into visualizations. The first things I chose to try and display were:</p><ol><li>update loop timing</li><li>queue size</li><li>table of the most recent 400 values, which is roughly one full LiDAR rotation.</li></ol><p>A 20 Hz update rate was targeted. That means this information is going to update fast so it&rsquo;s more about watching it stream by and getting a feel and answering questions such as &ldquo;does my queue back up and start dropping data?</p><figure><img loading=lazy src=/posts/real-time-lidar-data-visualization-holoviews-panel/Panel-noViz.gif alt="Initial Panel dashboard with only text information"></figure><p>Now, I admit, I didn&rsquo;t spend a lot of time with the documentation before starting this. I quickly discovered that Bokeh does not support polar plots! That&rsquo;s really unfortunate, since I do use them frequently and they are the natural way to plot LiDAR data. So in the following code, and in the previous gif, I chose to convert polar coordinates to Cartesian coordinates.</p><p>Adding the simple visualization was quite easy from here. The code of how it was all achieved was:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>queue</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>holoviews</span> <span class=k>as</span> <span class=nn>hv</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>panel</span> <span class=k>as</span> <span class=nn>pn</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>bokeh.palettes</span> <span class=kn>import</span> <span class=n>Viridis256</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>hv</span><span class=o>.</span><span class=n>extension</span><span class=p>(</span><span class=s2>&#34;bokeh&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Dashboard</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span> <span class=n>scan_queue</span><span class=p>:</span> <span class=n>queue</span><span class=o>.</span><span class=n>Queue</span><span class=p>,</span> <span class=n>shutdown_event</span><span class=p>:</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scan_queue</span> <span class=o>=</span> <span class=n>scan_queue</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>shutdown_event</span> <span class=o>=</span> <span class=n>shutdown_event</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>scan_cols</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;Timestamp&#34;</span><span class=p>,</span> <span class=s2>&#34;x&#34;</span><span class=p>,</span> <span class=s2>&#34;y&#34;</span><span class=p>,</span> <span class=s2>&#34;Quality&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recent_scans</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>scan_cols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>table</span> <span class=o>=</span> <span class=n>pn</span><span class=o>.</span><span class=n>widgets</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>recent_scans</span><span class=p>,</span> <span class=n>width</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>height</span><span class=o>=</span><span class=mi>400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>queue_size_display</span> <span class=o>=</span> <span class=n>pn</span><span class=o>.</span><span class=n>widgets</span><span class=o>.</span><span class=n>StaticText</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;Queue Size&#34;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=s2>&#34;0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>update_loop_time</span> <span class=o>=</span> <span class=n>pn</span><span class=o>.</span><span class=n>widgets</span><span class=o>.</span><span class=n>StaticText</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=s2>&#34;Update Loop (ms)&#34;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_stream</span> <span class=o>=</span> <span class=n>hv</span><span class=o>.</span><span class=n>streams</span><span class=o>.</span><span class=n>Pipe</span><span class=p>(</span><span class=n>data</span><span class=o>=</span><span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>columns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>scan_cols</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>plot</span> <span class=o>=</span> <span class=n>hv</span><span class=o>.</span><span class=n>DynamicMap</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>create_plot</span><span class=p>,</span> <span class=n>streams</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>data_stream</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>plot</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>plot</span><span class=o>.</span><span class=n>options</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>framewise</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>width</span><span class=o>=</span><span class=mi>800</span><span class=p>,</span> <span class=n>height</span><span class=o>=</span><span class=mi>600</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;hover&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>num_qualities</span> <span class=o>=</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>        <span class=n>sampled_colors</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Viridis256</span><span class=p>[</span><span class=nb>int</span><span class=p>(</span><span class=n>i</span><span class=p>)]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>255</span><span class=p>,</span> <span class=n>num_qualities</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>quality_colors</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nb>str</span><span class=p>(</span><span class=n>i</span><span class=p>):</span> <span class=n>color</span> <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>color</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=n>num_qualities</span><span class=p>),</span> <span class=n>sampled_colors</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_plot</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>hv</span><span class=o>.</span><span class=n>plotting</span><span class=o>.</span><span class=n>element</span><span class=o>.</span><span class=n>Scatter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>data</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=n>data</span><span class=o>.</span><span class=n>empty</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>hv</span><span class=o>.</span><span class=n>Scatter</span><span class=p>([])</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>hv</span><span class=o>.</span><span class=n>Scatter</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>kdims</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;x&#34;</span><span class=p>],</span> <span class=n>vdims</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;y&#34;</span><span class=p>,</span> <span class=s2>&#34;Quality&#34;</span><span class=p>])</span><span class=o>.</span><span class=n>opts</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>size</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>color</span><span class=o>=</span><span class=s2>&#34;Quality&#34;</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>quality_colors</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update_dashboard</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>scan_queue</span><span class=o>.</span><span class=n>empty</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>scan</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>scan_queue</span><span class=o>.</span><span class=n>get_nowait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>rads</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>radians</span><span class=p>(</span><span class=n>scan</span><span class=o>.</span><span class=n>angle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=n>scan</span><span class=o>.</span><span class=n>distance</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>rads</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>y</span> <span class=o>=</span> <span class=n>scan</span><span class=o>.</span><span class=n>distance</span> <span class=o>*</span> <span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>rads</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>batch</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=n>scan</span><span class=o>.</span><span class=n>timestamp</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>scan</span><span class=o>.</span><span class=n>quality</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>batch</span><span class=p>:</span>  <span class=c1># Only concatenate if new data exists</span>
</span></span><span class=line><span class=cl>            <span class=n>new_df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>(</span><span class=n>batch</span><span class=p>,</span> <span class=n>columns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>scan_cols</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>recent_scans</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>concat</span><span class=p>([</span><span class=bp>self</span><span class=o>.</span><span class=n>recent_scans</span><span class=p>,</span> <span class=n>new_df</span><span class=p>])</span><span class=o>.</span><span class=n>tail</span><span class=p>(</span><span class=mi>400</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>table</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>recent_scans</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_stream</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>recent_scans</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>queue_size_display</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Create and display the dashboard view</span>
</span></span><span class=line><span class=cl>        <span class=n>view</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>view</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>server</span> <span class=o>=</span> <span class=n>pn</span><span class=o>.</span><span class=n>serve</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>show</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>threaded</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Update loop</span>
</span></span><span class=line><span class=cl>        <span class=n>target_refresh</span> <span class=o>=</span> <span class=mf>0.05</span>  <span class=c1># 20 Hz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>shutdown_event</span><span class=o>.</span><span class=n>is_set</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>update_dashboard</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>elapsed_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>update_loop_time</span><span class=o>.</span><span class=n>value</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>elapsed_time</span> <span class=o>*</span> <span class=mi>1000</span><span class=si>:</span><span class=s2> .2f</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>sleep_time</span> <span class=o>=</span> <span class=n>target_refresh</span> <span class=o>-</span> <span class=n>elapsed_time</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>sleep_time</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>sleep_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>server</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>view</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>pn</span><span class=o>.</span><span class=n>Column</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pn</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>update_loop_time</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue_size_display</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>plot</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>table</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></div><p>Additionally, I need a script to call both the producer and consumer loops, which I will save as <code>main.py</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>queue</span> <span class=kn>import</span> <span class=n>Queue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>src.config_util</span> <span class=kn>import</span> <span class=n>load_config</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>src.dashboard</span> <span class=kn>import</span> <span class=n>Dashboard</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>src.rpLiDAR_interface</span> <span class=kn>import</span> <span class=n>RPLiDAR</span><span class=p>,</span> <span class=n>create_LiDAR_instance</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shutdown_event</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Event</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=n>load_config</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>scan_queue</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;queue&#34;</span><span class=p>][</span><span class=s2>&#34;size&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>create_LiDAR_instance</span><span class=p>(</span><span class=n>config</span><span class=p>,</span> <span class=n>scan_queue</span><span class=p>)</span> <span class=k>as</span> <span class=n>rpLiDAR</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>rpLiDAR</span><span class=o>.</span><span class=n>start_scan</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Starting dashboard&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>dashboard</span> <span class=o>=</span> <span class=n>Dashboard</span><span class=p>(</span><span class=n>scan_queue</span><span class=p>,</span> <span class=n>shutdown_event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Serving dashboard&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>dashboard</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Dashboard exited&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>KeyboardInterrupt</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;KeyboardInterrupt detected. Shutting down.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>shutdown_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>rpLiDAR</span><span class=o>.</span><span class=n>stop_scan</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;An error occurred: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>shutdown_event</span><span class=o>.</span><span class=n>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>rpLiDAR</span><span class=o>.</span><span class=n>stop_scan</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><p>And with the plot added, the dashboard became:</p><figure><img loading=lazy src=/posts/real-time-lidar-data-visualization-holoviews-panel/Panel-Viz.gif alt="Panel dashboard with an XY scatter plot"></figure><p>The results are quite good. The gif format doesn&rsquo;t adequately capture how smooth and quickly it runs, but it was excellent. My queue size remains small and my update loop is running more than fast enough to keep up with my chosen update rate. The visualization isn&rsquo;t perfect and needs work &ndash; the XY coordinates can adjust in and out wildly with outliers or changes in scans and the legend isn&rsquo;t sorted with values coming in and out.</p><p>The code to implement a dashboard in Panel and a visualization using Holoviws is straightforward and effective. I would say, for those learning, there are two trickier things to notice:</p><ul><li><p>since I don’t expect all scans to have all quality values (0-15) it is worth mapping colors to values explicitly so, for each refresh, the mapping doesn’t change on us.</p></li><li><p>Timing is important and I’m not sure how long things would take to execute. I expected it could take some fiddling. I know running in a browser is going to be limiting regardless and felt like aiming for 20 Hz was ambitious. As a result, I implemented a timing loop that accounts for the length of time <code>update_dashboard()</code> takes to execute. While not strictly necessary for this project, adopting good practices will pay off in the long run.</p></li></ul><p>I will also admit that one could argue I could have more cleanly handled exiting by using <code>threading.Event()</code> for both the dashboard and the rplidar interface. When I arrived at this point I didn&rsquo;t bother to adjust anything since I knew I wouldn&rsquo;t be keeping the dashboard code for future projects and the interface would work well, as it was, in my next project.</p><p>There was, however, more latency than I expected between an object moving in my environment and it being displayed as moving on the plot. Again, the queue is being emptied quickly, the update loop is running within my desired bounds, and I know this LiDAR itself does not have this observed latency. Therefore, I suspect it is a limitation of using a browser to render such visualizations.There is a reason when I&rsquo;ve needed custom visualization tools for such applications professionally I have typically turned to using Qt. I&rsquo;ll likely profile all this and get to the bottom of it in the future.</p><h2 id=key-learnings-and-conclusion>Key Learnings and Conclusion<a hidden class=anchor aria-hidden=true href=#key-learnings-and-conclusion>#</a></h2><p>Although the work is incomplete and there are a number of very obvious ways I can continue to refine this, it&rsquo;s worth reflecting on the experience so far. Setting up the hardware went smoothly and it performed as expected. I was able to easily develop an interface for it that will be useful for many projects and set up a mock interface and some testing as well.</p><p>In reflecting on my exploration of Holoviews and Panel for visualizing LiDAR data in real-time, I found both tools to offer unique advantages that complement my experiences with other Python-based prototyping tools such as Streamlit and Plotly. Streamlit has been my go-to for rapidly developing data-driven prototype applications, thanks to its straightforward interaction model. Plotly, within Streamlit, has served well for creating interactive plots, leveraging its extensive features and ease of use. However, the exploration into Panel and Holoviews, particularly with the Bokeh backend, revealed a flexible and efficient framework for building interactive applications, especially beneficial for complex tasks requiring state maintenance and more granular control over data updates without full page reloads.</p><p>The limitation of Bokeh, such as its lack of native support for polar plots, was a notable drawback in the context of LiDAR data visualization. This constraint necessitated a workaround by converting polar coordinates to Cartesian, which, while effective, underscored that it is a community driven library that is under active development and still does not support the wide variety of plots we use in engineering and scientific contexts. Although I didn&rsquo;t delve into detailed performance profiling, the real-time responsiveness of the dashboard fell short of my expectations. Despite the efficiency in data handling and update mechanisms, the visualization exhibited more latency than desirable for real-time applications. I don’t blame Panel or Holoviews, but I fully admit that there is almost certainly a fundamental limit to pushing this much information through a web browser.</p><p>With all that said, supporting and experimenting with community-driven open-source solutions like Holoviews and Panel is, in my opinion, imperative. Free/Libre Open Source Software has changed my life, and I know I&rsquo;m not alone in that. For personal projects, I will continue to use and, hopefully, contribute to the excellent Holoviz ecosystem.</p><p></p><hr><h2 id=continuing-the-conversation>Continuing the Conversation<a hidden class=anchor aria-hidden=true href=#continuing-the-conversation>#</a></h2><p>Let&rsquo;s shape the future together: if you&rsquo;re willing to question assumptions and carve out unique paths towards progress, I&rsquo;m eager to partner with you.</p><p>The conversation shouldn&rsquo;t stop here. Every situation is unique and I value your experiences. I invite you to reach out to me directly, for feedback on this article or to start a dialogue on how we can transform your challenges into opportunities.</p><p><a href=https://www.dwblab.com/contact>Contact me</a>.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.dwblab.com/tags/sensors/>sensors</a></li></ul><nav class=paginav><a class=next href=https://www.dwblab.com/posts/return-to-office-announcements-why-your-best-people-are-upset/><span class=title>Next »</span><br><span>Return to Office Announcements: Why Your Best People Are So Upset</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.dwblab.com/>dwblab - Home of Douglas Breault: Innovative Leadership and Engineering</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>